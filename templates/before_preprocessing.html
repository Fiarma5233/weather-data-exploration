{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">{{ _('Résultats du prétraitement') }}</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row">
                <div class="col-md-12">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <div class="card mb-4">
        <div class="card-header">
            <h4>{{ _('Sélectionnez pour visualiser') }}</h4>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="stationSelector" class="form-label">{{ _('Station météo') }}:</label>
                    <select id="stationSelector" class="form-select">
                        {% for station in stations %}
                            <option value="{{ station }}" {% if station == station_selected %}selected{% endif %}>
                                {{ station }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="variableSelector" class="form-label">{{ _('Variable') }}:</label>
                    <select id="variableSelector" class="form-select" {% if not available_variables %}disabled{% endif %}>
                        {% if available_variables %}
                            {% for var in available_variables %}
                                <option value="{{ var }}" {% if var == variable_selected %}selected{% endif %}>
                                    {{ var }}
                                </option>
                            {% endfor %}
                        {% else %}
                            <option value="">{{ _('Aucune variable disponible') }}</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            <hr class="my-3">
            <p class="mb-2">
                {{ _('Station sélectionnée :') }} <strong>{{ station_selected }}</strong>
            </p>
            <p class="mb-0">
                {{ _('Variable sélectionnée :') }} <strong>{{ variable_selected if variable_selected else _('N/A') }}</strong>
            </p>
        </div>
    </div>

    <hr>

    {# Condition pour afficher les graphiques seulement si une variable est sélectionnée #}
    {% if variable_selected %}
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3>{{ _('Aperçu des Données Manquantes') }} ({{ variable_selected }})</h3>
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                        {% if missing_data_plot_html %}
                            {{ missing_data_plot_html | safe }}
                        {% else %}
                            <p>{{ _('Graphique des données manquantes non disponible pour cette variable.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3>{{ _('Comparaison des Outliers') }} ({{ variable_selected }})</h3>
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                        {% if outliers_plot_html %}
                            {{ outliers_plot_html | safe }}
                        {% else %}
                            <p>{{ _('Graphique des outliers non disponible pour cette variable.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3>{{ _('Chronologie des Lacunes de Données') }} ({{ variable_selected }})</h3>
                    </div>
                    <div class="card-body">
                        {% if missing_ranges_plot_html %}
                            {{ missing_ranges_plot_html | safe }}
                        {% else %}
                            <p>{{ _('Graphique des plages manquantes non disponible pour cette variable.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <p class="alert alert-info">{{ _('Veuillez sélectionner une station et une variable pour afficher les visualisations.') }}</p>
    {% endif %}
</div>

<script>
// Script pour gérer les sélecteurs de station et de variable
document.addEventListener('DOMContentLoaded', function() {
    var stationSelector = document.getElementById('stationSelector');
    var variableSelector = document.getElementById('variableSelector');

    // Écouteur pour le changement de station
    stationSelector.addEventListener('change', function() {
        var selectedStation = this.value;
        // Redirige vers la même route avec la nouvelle station.
        // La variable sera soit la première disponible, soit celle précédemment sélectionnée si elle existe pour la nouvelle station.
        window.location.href = `{{ url_for('visualiser_resultats_pretraitement') }}?station=${selectedStation}`;
    });

    // Écouteur pour le changement de variable
    variableSelector.addEventListener('change', function() {
        var selectedStation = stationSelector.value; // Récupère la station actuellement sélectionnée
        var selectedVariable = this.value;
        // Redirige vers la même route avec la station et la nouvelle variable
        window.location.href = `{{ url_for('visualiser_resultats_pretraitement') }}?station=${selectedStation}&variable=${selectedVariable}`;
    });

    // Aucune logique Plotly.newPlot ici car les graphiques sont inclus directement en HTML par Flask.
    // La bibliothèque Plotly.js est chargée via 'cdn' dans le premier fig.to_html()
    // et est disponible globalement.
});
</script>
{% endblock %}